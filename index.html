<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Warehouse Leads Map Portal</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
    }
    /* Full-screen Map */
    #map {
      height: 100vh;
      width: 100%;
    }
    /* Popup Content Styling */
    .leaflet-popup-content {
      font-size: 14px;
      line-height: 1.5;
    }
    .popup-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .popup-section {
      margin-bottom: 8px;
    }
    a {
      color: #0078A8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Map Container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize the map – adjust center and zoom as needed
    var map = L.map('map').setView([32.08, -81.1], 8);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Define custom marker icons for green (complete info) and yellow (incomplete info)
    var greenIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    var yellowIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Helper: Check if a field has a valid (non-empty and not "N/A") value.
    function isValid(value) {
      return value && value.trim() !== '' && value.trim().toUpperCase() !== 'N/A';
    }

    // Dummy geocoding function as a fallback (offset markers)
    function getDummyCoordinates(index) {
      var baseLat = 32.08;
      var baseLon = -81.1;
      return [baseLat + (index * 0.005), baseLon + (index * 0.005)];
    }

    // Function to geocode an address using Nominatim
    function geocodeAddress(address) {
      return fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(address))
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data && data.length > 0) {
            return {
              lat: parseFloat(data[0].lat),
              lon: parseFloat(data[0].lon)
            };
          }
          return null;
        })
        .catch(function(err) {
          console.error('Geocoding error:', err);
          return null;
        });
    }

    // Function to add a marker to the map
    function addMarker(row, lat, lon) {
      // Extract fields from CSV (adjust these if your CSV headers differ)
      var propertyName = row["Property Name"] || "Unnamed Property";
      var address      = row["Address"] || "";
      var phone        = row["Phone Number"] || "";
      var website      = row["Website"] || "";
      var propertyMgmt = row["Property Mgmt Company"] || "";
      var mgmtPhone    = row["Mgmt Phone"] || "";
      var mgmtEmail    = row["Mgmt Email"] || "";
      var leasingAgent = row["Leasing Agent"] || "";
      var agentPhone   = row["Agent Phone"] || "";
      var agentEmail   = row["Agent Email"] || "";

      // Determine marker color based on data completeness
      var hasManagementAndLeasing = isValid(propertyMgmt) && isValid(leasingAgent);
      var markerIcon = hasManagementAndLeasing ? greenIcon : yellowIcon;

      // Construct the popup content
      var popupContent = '<div class="popup-content">' +
        '<div class="popup-header">' + propertyName + '</div>' +
        '<div class="popup-section"><strong>Address:</strong> ' + address + '</div>' +
        '<div class="popup-section"><strong>Phone:</strong> ' + phone + '</div>' +
        (website ? '<div class="popup-section"><strong>Website:</strong> <a href="http://' + website + '" target="_blank">' + website + '</a></div>' : '') +
        (isValid(propertyMgmt) ? '<div class="popup-section"><strong>Property Management:</strong> ' + propertyMgmt + '</div>' : '') +
        (isValid(mgmtPhone) ? '<div class="popup-section"><strong>Mgmt Phone:</strong> ' + mgmtPhone + '</div>' : '') +
        (isValid(mgmtEmail) ? '<div class="popup-section"><strong>Mgmt Email:</strong> ' + mgmtEmail + '</div>' : '') +
        (isValid(leasingAgent) ? '<div class="popup-section"><strong>Leasing Agent:</strong> ' + leasingAgent + '</div>' : '') +
        (isValid(agentPhone) ? '<div class="popup-section"><strong>Agent Phone:</strong> ' + agentPhone + '</div>' : '') +
        (isValid(agentEmail) ? '<div class="popup-section"><strong>Agent Email:</strong> ' + agentEmail + '</div>' : '') +
        '</div>';

      // Create and add marker to the map
      var marker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);
      marker.bindPopup(popupContent);
    }

    // Parse the CSV file from the same folder as index.html
    Papa.parse("warehouse leads - Sheet1.csv", {
      download: true,
      header: true,
      complete: function(results) {
        var data = results.data;
        data.forEach(function(row, index) {
          // Check if Latitude and Longitude are provided in the CSV
          var lat = parseFloat(row["Latitude"]);
          var lon = parseFloat(row["Longitude"]);

          if (!isNaN(lat) && !isNaN(lon)) {
            // If coordinates exist, add marker immediately
            addMarker(row, lat, lon);
          } else {
            // Otherwise, use Nominatim to geocode the address
            var address = row["Address"] || "";
            if (address) {
              geocodeAddress(address).then(function(coords) {
                if (coords) {
                  addMarker(row, coords.lat, coords.lon);
                } else {
                  // Fallback to dummy coordinates if geocoding fails
                  var dummyCoords = getDummyCoordinates(index);
                  addMarker(row, dummyCoords[0], dummyCoords[1]);
                }
              });
            } else {
              // If no address provided, use dummy coordinates
              var dummyCoords = getDummyCoordinates(index);
              addMarker(row, dummyCoords[0], dummyCoords[1]);
            }
          }
        });
      },
      error: function(err) {
        console.error("Error loading CSV:", err);
      }
    });
  </script>
</body>
</html>
